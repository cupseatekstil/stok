<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Y√∂netim (Stabil)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* TASARIM AYNEN KORUNDU */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .header { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 11px; opacity: 0.9; }
        .btn { padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-top: 5px; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .hidden { display: none !important; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 5px; color: #666; font-size: 13px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-btn { border: none; background: none; color: #6b7280; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: #667eea; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .product-item { display: flex; gap: 10px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; margin-bottom: 10px; cursor: pointer; }
        .product-item-info { flex: 1; }
        .product-item-name { font-weight: bold; color: #333; }
        .product-item-stock-num { font-size: 20px; font-weight: bold; color: #667eea; }
        .back-btn { background: #6b7280; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .camera-container { width: 100%; height: 250px; background: #000; overflow: hidden; position: relative; }
        #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div class="container">
        <div id="mainScreen">
            <div class="header">
                <h3>üì¶ Stok Y√∂netim</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="totalProducts">0</div><div class="stat-label">√úr√ºn</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalValue">‚Ç∫0</div><div class="stat-label">Deƒüer</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalSales">0</div><div class="stat-label">Satƒ±≈ü</div></div>
                </div>
            </div>
            <div class="card">
                <div class="input-group"><input type="text" id="searchInput" placeholder="üîç √úr√ºn ara..." oninput="renderProducts()"></div>
                <div id="productList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="addProductScreen" class="hidden">
            <button class="back-btn" onclick="showScreen('main')">‚Üê Geri</button>
            <div class="card">
                <h3>Yeni √úr√ºn Ekle</h3>
                <div class="input-group"><label>Barkod</label><input type="text" id="newBarcode"></div>
                <div class="input-group"><label>√úr√ºn Adƒ±</label><input type="text" id="newName"></div>
                <div class="input-group"><label>Kategori</label><select id="newCategory"><option>Giyim</option><option>Elektronik</option><option>Diƒüer</option></select></div>
                <div class="input-group"><label>Maliyet (‚Ç∫)</label><input type="number" id="newCost"></div>
                <div class="input-group"><label>Stok Adedi</label><input type="number" id="newStock"></div>
                <button class="btn btn-success" onclick="saveProduct()">üíæ KAYDET</button>
            </div>
        </div>

        <div id="productDetailScreen" class="hidden">
            <button class="back-btn" onclick="showScreen('main')">‚Üê Geri</button>
            <div class="card">
                <h3 id="detailName">√úr√ºn Adƒ±</h3>
                <p>Barkod: <span id="detailBarcode"></span></p>
                <p>Maliyet: <span id="detailCost"></span></p>
                <div class="stat-card" style="margin: 10px 0;">
                    <div class="stat-value" id="detailStock">0</div>
                    <div class="stat-label">STOK</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="updateStock(-1)">‚ûñ SATI≈û YAP</button>
                    <button class="btn btn-success" onclick="updateStock(1)">‚ûï STOK EKLE</button>
                </div>
                <button class="btn btn-secondary" onclick="deleteProduct()" style="background:#ff4757; margin-top:15px">üóëÔ∏è Sƒ∞L</button>
            </div>
        </div>

        <div id="scannerScreen" class="hidden">
            <button class="back-btn" onclick="showScreen('main')">‚Üê Geri</button>
            <div class="card">
                <h3>Barkod Okut</h3>
                <div class="camera-container"><div id="scanner-container"></div></div>
            </div>
        </div>
        
        <div id="salesScreen" class="hidden">
            <button class="back-btn" onclick="showScreen('main')">‚Üê Geri</button>
            <div class="card">
                <h3>Satƒ±≈ü Ge√ßmi≈üi</h3>
                <div id="salesList"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('main')"><div class="nav-icon">üè†</div>Ana Sayfa</button>
        <button class="nav-btn" onclick="showScreen('scanner')"><div class="nav-icon">üì∑</div>Barkod</button>
        <button class="nav-btn" onclick="showScreen('add')"><div class="nav-icon">‚ûï</div>Ekle</button>
        <button class="nav-btn" onclick="showScreen('sales')"><div class="nav-icon">üìä</div>Satƒ±≈ülar</button>
    </div>

    <script>
        // --- 1. FIREBASE AYARLARI (BURAYA KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞Nƒ∞ Gƒ∞R) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBt5AmmhZc6sI764z8hMjGusAzNRMIrxLw",
            authDomain: "stoktakip-4779c.firebaseapp.com",
            projectId: "stoktakip-4779c",
            storageBucket: "stoktakip-4779c.firebasestorage.app",
            messagingSenderId: "751946906534",
            appId: "1:751946906534:web:e28257e6487a638af7ed67"
        };

        // Firebase Ba≈ülatma
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let products = [];
        let sales = [];
        let selectedProduct = null;
        let scannerActive = false;

        // --- 2. VERƒ∞LERƒ∞ OTOMATƒ∞K √áEKME ---
        db.collection("products").onSnapshot(snapshot => {
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProducts();
            updateStats();
        });

        db.collection("sales").onSnapshot(snapshot => {
            sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSales();
            updateStats();
        });

        // --- 3. EKRAN DEƒûƒ∞≈ûTƒ∞RME ---
        function showScreen(screenName) {
            // T√ºm ekranlarƒ± gizle
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('addProductScreen').classList.add('hidden');
            document.getElementById('productDetailScreen').classList.add('hidden');
            document.getElementById('scannerScreen').classList.add('hidden');
            document.getElementById('salesScreen').classList.add('hidden');

            // ƒ∞steneni a√ß
            document.getElementById(screenName + 'Screen').classList.remove('hidden');

            // Kamera kapat (scanner deƒüilse)
            if(screenName !== 'scanner') stopScanner();
            if(screenName === 'scanner') startScanner();
        }

        // --- 4. √úR√úN ƒ∞≈ûLEMLERƒ∞ ---
        function saveProduct() {
            const barcode = document.getElementById('newBarcode').value;
            const name = document.getElementById('newName').value;
            const category = document.getElementById('newCategory').value;
            const cost = Number(document.getElementById('newCost').value);
            const stock = Number(document.getElementById('newStock').value);

            if(!barcode || !name) return alert("Barkod ve ƒ∞sim zorunludur!");

            db.collection("products").add({
                barcode, name, category, cost, stock
            }).then(() => {
                alert("Kaydedildi!");
                showScreen('main');
                // Temizle
                document.getElementById('newBarcode').value = "";
                document.getElementById('newName').value = "";
                document.getElementById('newStock').value = "";
            }).catch(err => alert("Hata: " + err.message));
        }

        function renderProducts() {
            const list = document.getElementById('productList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = "";

            products.filter(p => p.name.toLowerCase().includes(search) || p.barcode.includes(search))
            .forEach(p => {
                const div = document.createElement('div');
                div.className = "product-item";
                div.onclick = () => showDetail(p);
                div.innerHTML = `
                    <div class="product-item-info">
                        <div class="product-item-name">${p.name}</div>
                        <div style="font-size:12px; color:#666">${p.barcode}</div>
                    </div>
                    <div class="product-item-stock-num">${p.stock}</div>
                `;
                list.appendChild(div);
            });
        }

        function showDetail(product) {
            selectedProduct = product;
            document.getElementById('detailName').innerText = product.name;
            document.getElementById('detailBarcode').innerText = product.barcode;
            document.getElementById('detailCost').innerText = product.cost + " ‚Ç∫";
            document.getElementById('detailStock').innerText = product.stock;
            showScreen('productDetail');
        }

        function updateStock(amount) {
            if(!selectedProduct) return;
            
            const newStock = Number(selectedProduct.stock) + amount;
            if(newStock < 0) return alert("Stok yetersiz!");

            db.collection("products").doc(selectedProduct.id).update({
                stock: newStock
            });

            // Satƒ±≈ü yapƒ±ldƒ±ysa kaydet
            if(amount < 0) {
                db.collection("sales").add({
                    productName: selectedProduct.name,
                    barcode: selectedProduct.barcode,
                    quantity: 1,
                    date: new Date()
                });
            }
        }

        function deleteProduct() {
            if(confirm("Silmek istediƒüine emin misin?")) {
                db.collection("products").doc(selectedProduct.id).delete();
                showScreen('main');
            }
        }

        function updateStats() {
            document.getElementById('totalProducts').innerText = products.length;
            const val = products.reduce((acc, p) => acc + (p.cost * p.stock), 0);
            document.getElementById('totalValue').innerText = val + " ‚Ç∫";
            document.getElementById('totalSales').innerText = sales.length;
        }

        function renderSales() {
            const list = document.getElementById('salesList');
            list.innerHTML = sales.map(s => `
                <div class="product-item" style="cursor:default">
                    <div class="product-item-info">${s.productName}</div>
                    <div style="font-weight:bold; color:green">1 Adet</div>
                </div>
            `).join('');
        }

        // --- 5. BARKOD OKUYUCU ---
        function startScanner() {
            scannerActive = true;
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-container'), constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader"] }
            }, function(err) {
                if(!err) Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if(!scannerActive) return;
                const code = result.codeResult.code;
                stopScanner();
                
                const product = products.find(p => p.barcode === code);
                if(product) {
                    showDetail(product);
                } else {
                    if(confirm("√úr√ºn bulunamadƒ±. Eklemek ister misin?")) {
                        document.getElementById('newBarcode').value = code;
                        showScreen('add');
                    } else {
                        showScreen('main');
                    }
                }
            });
        }

        function stopScanner() {
            scannerActive = false;
            Quagga.stop();
        }
    </script>
</body>
</html>
