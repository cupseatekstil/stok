<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Stok Pro v7.3</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4F46E5; --bg-body: #F3F4F6; --bg-card: #ffffff;
            --text-main: #1F2937; --success: #10B981; --danger: #EF4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); padding-bottom: 120px; }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4F46E5, #EC4899);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 30px; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); }
        .pin-dot.active { background: white; transform: scale(1.2); border: none; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .num-btn { width: 75px; height: 75px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 26px; display: flex; align-items: center; justify-content: center; }

        /* --- UI --- */
        .header { background: var(--bg-card); padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .sq-card { aspect-ratio: 1.1; background: var(--bg-card); border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 4px solid #ddd; cursor: pointer; transition: transform 0.1s; }
        .sq-card:active { transform: scale(0.95); }
        
        .kasa-card { background: var(--bg-card); border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }

        /* List & Log Items */
        .item-card { display: flex; align-items: center; gap: 12px; background: white; padding: 10px; border-radius: 15px; margin-bottom: 8px; border: 1px solid #eee; }
        .item-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #f0f0f0; }

        /* Scanner */
        #scanner-box { width: 100%; height: 250px; background: #000; border-radius: 20px; overflow: hidden; position: relative; }

        /* Buttons & Inputs */
        .input-group { background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
        .input-group input { background: none; border: none; outline: none; width: 100%; font-size: 14px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border:none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; width:92%; max-width:400px; padding:20px; border-radius:25px; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 100px; background: white; display: flex; justify-content: space-around; align-items: center; padding-bottom: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.08); z-index: 100; }
        .nav-item { border: none; background: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 15px; font-weight: 700; gap: 5px; }
        .nav-item i { font-size: 32px; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body data-theme="light">

    <div id="login-screen">
        <div style="font-size: 50px;">üîê</div>
        <h3 style="margin: 15px 0;">Sistem Kilidi</h3>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="numpad">
            <div class="num-btn" onclick="enterPin('1')">1</div><div class="num-btn" onclick="enterPin('2')">2</div><div class="num-btn" onclick="enterPin('3')">3</div>
            <div class="num-btn" onclick="enterPin('4')">4</div><div class="num-btn" onclick="enterPin('5')">5</div><div class="num-btn" onclick="enterPin('6')">6</div>
            <div class="num-btn" onclick="enterPin('7')">7</div><div class="num-btn" onclick="enterPin('8')">8</div><div class="num-btn" onclick="enterPin('9')">9</div>
            <div class="num-btn" onclick="clearPin()">C</div><div class="num-btn" onclick="enterPin('0')">0</div><div class="num-btn" onclick="submitPin()">‚ûú</div>
        </div>
    </div>

    <div class="header">
        <div><small>Stok Takip</small><h2 id="page-title">Ana Sayfa</h2></div>
        <button onclick="logout()" style="border:none; background:none; color:var(--danger); font-size: 22px;"><i class="fas fa-power-off"></i></button>
    </div>

    <div class="container">
        <div id="tab-dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="sq-card" style="color:var(--primary); border-color:var(--primary)" onclick="switchTab('products')">
                    <b id="d-count" style="font-size:24px">0</b><small>√áe≈üit</small>
                </div>
                <div class="sq-card" style="color:var(--success); border-color:var(--success)" onclick="switchTab('products')">
                    <b id="d-stock" style="font-size:24px">0</b><small>Toplam Stok</small>
                </div>
                <div class="sq-card" style="color:var(--warning); border-color:var(--warning)">
                    <b id="d-value" style="font-size:18px">‚Ç∫0</b><small>Deƒüer</small>
                </div>
                <div class="sq-card" style="color:var(--danger); border-color:var(--danger)" onclick="switchTab('products', true)">
                    <b id="d-low" style="font-size:24px">0</b><small>Kritik</small>
                </div>
            </div>
            <div class="kasa-card">
                <h3><i class="fas fa-book"></i> Kasa Defteri</h3>
                <p id="kasa-ozet" style="color:#999; margin-top:10px">G√ºnl√ºk ciro ve hareketler burada toplanacak.</p>
            </div>
        </div>

        <div id="tab-scan" class="tab-content" style="display:none">
            <div class="kasa-card">
                <div id="scanner-box"><div id="scanner-viewport" style="width:100%; height:100%"></div></div>
                <div style="margin-top:20px">
                    <button class="btn btn-primary" id="btn-start" onclick="startScanner()" style="font-size:18px"><i class="fas fa-barcode"></i> TARAMAYI BA≈ûLAT</button>
                    <button class="btn btn-danger" id="btn-stop" onclick="stopScanner()" style="display:none">DURDUR</button>
                </div>
            </div>
            <div class="kasa-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4><i class="fas fa-history"></i> Son ƒ∞≈ülemler</h4>
                    <button onclick="clearLogs()" style="background:none; border:none; color:var(--danger); font-size:12px; font-weight:600">Temizle</button>
                </div>
                <div id="log-container"></div>
            </div>
        </div>

        <div id="tab-add" class="tab-content" style="display:none">
            <div class="kasa-card">
                <div style="background:#f0f0f0; height:150px; border-radius:15px; display:flex; align-items:center; justify-content:center; margin-bottom:15px; overflow:hidden; border:2px dashed #ccc" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" hidden accept="image/*" onchange="previewImg(this, 'add-img-preview')">
                    <img id="add-img-preview" style="width:100%; height:100%; object-fit:cover; display:none">
                    <div id="add-icon-box" style="text-align:center"><i class="fas fa-camera fa-2x"></i><br><small>G√∂rsel Ekle</small></div>
                </div>
                <div class="input-group"><i class="fas fa-barcode"></i><input type="text" id="inp-barcode" placeholder="Barkod"></div>
                <div class="input-group"><i class="fas fa-tag"></i><input type="text" id="inp-name" placeholder="√úr√ºn Adƒ±"></div>
                <div class="input-group"><i class="fas fa-lira-sign"></i><input type="number" id="inp-price" placeholder="Fiyat"></div>
                <div class="input-group"><i class="fas fa-cubes"></i><input type="number" id="inp-stock" placeholder="Mevcut Stok"></div>
                <div class="input-group"><i class="fas fa-bell"></i><input type="number" id="inp-min" placeholder="Kritik Stok Sƒ±nƒ±rƒ±"></div>
                <button class="btn btn-primary" onclick="saveProduct()">KAYDET</button>
            </div>
        </div>

        <div id="tab-products" class="tab-content" style="display:none">
            <div class="input-group"><i class="fas fa-search"></i><input type="text" id="search-box" placeholder="Depoda ara..." oninput="renderList()"></div>
            <div id="list-container"></div>
        </div>
    </div>

    <div class="modal" id="modal-edit">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>√úr√ºn ƒ∞≈ülemi</h3><i class="fas fa-times" onclick="closeModal()"></i></div>
            <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                <img id="modal-img" style="width:70px; height:70px; border-radius:12px; object-fit:cover">
                <div><b id="modal-name-text">√úr√ºn Adƒ±</b><br><small id="modal-barcode-text"></small></div>
            </div>
            <input type="hidden" id="edit-id">
            <div class="input-group"><i class="fas fa-tag"></i><input type="text" id="edit-name" placeholder="Ad"></div>
            <div class="input-group"><i class="fas fa-cubes"></i><input type="number" id="edit-stock" placeholder="Stok"></div>
            <div class="input-group"><i class="fas fa-lira-sign"></i><input type="number" id="edit-price" placeholder="Fiyat"></div>
            <button class="btn btn-primary" onclick="updateProduct()">G√úNCELLE</button>
            <button class="btn" style="color:var(--danger); background:none; margin-top:5px" onclick="deleteProduct()">Sil</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i>Ana</button>
        <button class="nav-item" onclick="switchTab('scan')"><i class="fas fa-barcode"></i>Okut</button>
        <button class="nav-item" onclick="switchTab('add')"><i class="fas fa-plus-circle"></i>Ekle</button>
        <button class="nav-item" onclick="switchTab('products')"><i class="fas fa-warehouse"></i>Depo</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt5AmmhZc6sI764z8hMjGusAzNRMIrxLw",
            authDomain: "stoktakip-4779c.firebaseapp.com",
            databaseURL: "https://stoktakip-4779c-default-rtdb.firebaseio.com",
            projectId: "stoktakip-4779c",
            storageBucket: "stoktakip-4779c.firebasestorage.app",
            messagingSenderId: "751946906534",
            appId: "1:751946906534:web:e28257e6487a638af7ed67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let products = [];
        let logs = [];
        let currentPin = "";
        let tempImg = "";

        // PIN & AUTH (Otomatik Giri≈ü 588558)
        function enterPin(n) { if(currentPin.length < 6) { currentPin += n; updateDots(); if(currentPin.length === 6) setTimeout(submitPin, 200); } }
        function updateDots() { document.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('active', i < currentPin.length)); }
        function submitPin() { if(currentPin === "588558") { localStorage.setItem('stokAuth', 'true'); document.getElementById('login-screen').style.display = 'none'; initApp(); } else { currentPin = ""; updateDots(); alert("≈ûifre Yanlƒ±≈ü!"); } }
        function clearPin() { currentPin = ""; updateDots(); }
        function logout() { localStorage.removeItem('stokAuth'); location.reload(); }

        window.onload = () => { if(localStorage.getItem('stokAuth') === 'true') { document.getElementById('login-screen').style.display = 'none'; initApp(); } };

        function initApp() {
            db.ref('products').on('value', snap => {
                const data = snap.val();
                products = data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : [];
                updateUI();
            });
            db.ref('logs').limitToLast(15).on('value', snap => {
                const data = snap.val();
                logs = data ? Object.values(data).reverse() : [];
                renderLogs();
            });
        }

        function switchTab(id, filterCritical = false) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + id).style.display = 'block';
            document.getElementById('page-title').innerText = id === 'products' ? 'Depo' : (id === 'add' ? 'Ekle' : (id === 'scan' ? 'Barkod' : 'Ana Sayfa'));
            
            const idx = id === 'dashboard' ? 0 : (id === 'scan' ? 1 : (id === 'add' ? 2 : 3));
            document.querySelectorAll('.nav-item')[idx].classList.add('active');

            // KRƒ∞Tƒ∞K STOK Fƒ∞LTRESƒ∞
            if(filterCritical && id === 'products') {
                const lowCodes = products.filter(p => Number(p.stock) <= Number(p.minStock)).map(p => p.barcode);
                renderList(true); // √ñzel render
            } else if (id === 'products') {
                document.getElementById('search-box').value = "";
                renderList();
            }
        }

        function renderList(onlyCritical = false) {
            const s = document.getElementById('search-box').value.toLowerCase();
            const cont = document.getElementById('list-container');
            let filtered = products.filter(p => p.name.toLowerCase().includes(s) || p.barcode.includes(s));
            
            if(onlyCritical) {
                filtered = filtered.filter(p => Number(p.stock) <= Number(p.minStock));
                document.getElementById('search-box').placeholder = "Kritik √ºr√ºnler listeleniyor...";
            } else {
                document.getElementById('search-box').placeholder = "Depoda ara...";
            }

            cont.innerHTML = filtered.map(p => {
                const isLow = Number(p.stock) <= Number(p.minStock);
                return `
                <div class="item-card" onclick="openEdit('${p.id}')" style="border-left: 5px solid ${isLow ? 'var(--danger)' : 'var(--success)'}">
                    <img src="${p.image || 'https://via.placeholder.com/60'}" class="item-img">
                    <div style="flex:1"><b>${p.name}</b><br><small>${p.barcode}</small></div>
                    <div style="text-align:right"><b>${p.stock}</b><br><small>‚Ç∫${p.price}</small></div>
                </div>`;
            }).join('');
        }

        // Dƒ∞ƒûER FONKSƒ∞YONLAR (LOG, SAVE, UPDATE)
        function renderLogs() {
            const cont = document.getElementById('log-container');
            if(!cont) return;
            if(logs.length === 0) { cont.innerHTML = '<div style="text-align:center; padding:15px; color:#999; font-size:12px">Hen√ºz i≈ülem yok</div>'; return; }
            cont.innerHTML = logs.map(l => {
                const color = l.type === 'out' ? 'var(--danger)' : (l.type === 'in' ? 'var(--success)' : 'var(--primary)');
                return `<div class="item-card" style="border-left: 4px solid ${color}"><img src="${l.pImg || 'https://via.placeholder.com/50'}" class="item-img"><div style="flex:1"><div style="font-weight:600; font-size:13px">${l.pName}</div><div style="color:#999; font-size:11px">${new Date(l.date).toLocaleTimeString('tr-TR')}</div></div><div style="font-weight:700; color:${color}">${l.type==='out'?'-':'+'}${l.amount}</div></div>`;
            }).join('');
        }

        function saveLog(pName, pImg, type, amount) { db.ref('logs').push({ pName, pImg: pImg || '', type, amount, date: Date.now() }); }

        function previewImg(input, targetId) { if(input.files && input.files[0]) { const r = new FileReader(); r.onload = e => { tempImg = e.target.result; document.getElementById(targetId).src = tempImg; document.getElementById(targetId).style.display = 'block'; document.getElementById('add-icon-box').style.display = 'none'; }; r.readAsDataURL(input.files[0]); } }

        function saveProduct() {
            const p = { barcode: document.getElementById('inp-barcode').value, name: document.getElementById('inp-name').value, price: document.getElementById('inp-price').value, stock: document.getElementById('inp-stock').value, minStock: document.getElementById('inp-min').value || 5, image: tempImg };
            if(!p.barcode || !p.name) return alert("Eksik alan!");
            db.ref('products').push(p).then(() => { saveLog(p.name, p.image, 'in', p.stock); tempImg = ""; document.querySelectorAll('input').forEach(i => i.value = ""); document.getElementById('add-img-preview').style.display = 'none'; document.getElementById('add-icon-box').style.display = 'block'; switchTab('products'); });
        }

        function updateProduct() {
            const id = document.getElementById('edit-id').value;
            const p = products.find(x => x.id === id);
            const oldStock = Number(p.stock);
            const newStock = Number(document.getElementById('edit-stock').value);
            db.ref('products/' + id).update({ name: document.getElementById('edit-name').value, stock: newStock, price: document.getElementById('edit-price').value }).then(() => {
                if(newStock !== oldStock) { saveLog(p.name, p.image, (newStock - oldStock) > 0 ? 'in' : 'out', Math.abs(newStock - oldStock)); }
                closeModal();
            });
        }

        function updateUI() {
            const tStock = products.reduce((a,b) => a + Number(b.stock), 0);
            const tValue = products.reduce((a,b) => a + (Number(b.stock) * Number(b.price)), 0);
            const tLow = products.filter(p => Number(p.stock) <= Number(p.minStock)).length;
            document.getElementById('d-count').innerText = products.length;
            document.getElementById('d-stock').innerText = tStock;
            document.getElementById('d-value').innerText = '‚Ç∫' + tValue.toLocaleString('tr-TR');
            document.getElementById('d-low').innerText = tLow;
            renderList();
        }

        function startScanner() {
            Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-viewport') }, decoder: { readers: ["ean_reader", "code_128_reader"] } }, err => {
                if(err) return; Quagga.start();
                document.getElementById('btn-start').style.display='none'; document.getElementById('btn-stop').style.display='block';
            });
            Quagga.onDetected(res => {
                const code = res.codeResult.code; stopScanner();
                const found = products.find(p => p.barcode === code);
                if(found) openEdit(found.id);
                else if(confirm("√úr√ºn bulunamadƒ±, eklensin mi?")) { document.getElementById('inp-barcode').value = code; switchTab('add'); }
            });
        }

        function stopScanner() { Quagga.stop(); document.getElementById('btn-start').style.display='block'; document.getElementById('btn-stop').style.display='none'; }
        function openEdit(id) { const p = products.find(x => x.id === id); document.getElementById('edit-id').value = id; document.getElementById('edit-name').value = p.name; document.getElementById('edit-stock').value = p.stock; document.getElementById('edit-price').value = p.price; document.getElementById('modal-img').src = p.image || 'https://via.placeholder.com/60'; document.getElementById('modal-name-text').innerText = p.name; document.getElementById('modal-barcode-text').innerText = p.barcode; document.getElementById('modal-edit').classList.add('active'); }
        function clearLogs() { if(confirm("Ge√ßmi≈ü silinsin mi?")) db.ref('logs').remove(); }
        function closeModal() { document.getElementById('modal-edit').classList.remove('active'); }
        function deleteProduct() { if(confirm("Silinsin mi?")) db.ref('products/'+document.getElementById('edit-id').value).remove().then(()=>closeModal()); }
    </script>
</body>
</html>
